name: Build and Package Ghost Theme

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: Build & Release Theme
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating releases and tagging
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for automated release notes and tag history

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Assets
        run: npm run build

      - name: Determine Next Version
        id: versioning
        run: |
          # Ensure tags are fetched
          git fetch --tags --force
          
          # Try to get the latest tag from git first, then fallback to GH release
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          
          # Validation: Ensure it matches vX.Y.Z
          if [[ "$LATEST_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Extract parts from tag
            CLEAN_TAG=${LATEST_TAG#v}
            IFS='.' read -r major minor patch <<< "$CLEAN_TAG"
            
            # Increment patch
            NEW_PATCH=$((patch + 1))
            NEW_TAG="v${major}.${minor}.${NEW_PATCH}"
            echo "Found latest tag/release $LATEST_TAG. Incrementing to $NEW_TAG"
          else
            # No valid previous tag/release found, use version from package.json
            VERSION=$(node -p "require('./package.json').version")
            NEW_TAG="v${VERSION}"
            echo "No valid previous version found (got: '$LATEST_TAG'). Using package.json version: $NEW_TAG"
          fi
          
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "THEME_NAME=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Package Theme
        id: package_theme
        run: |
          THEME_NAME=${{ steps.versioning.outputs.THEME_NAME }}
          NEW_TAG=${{ steps.versioning.outputs.NEW_TAG }}
          ZIP_NAME="${THEME_NAME}-${NEW_TAG}.zip"
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT
          
          # Create temporary folder for packaging
          mkdir -p dist_theme
          
          # Copy only theme-relevant files
          cp *.hbs dist_theme/
          CP_FILES="package.json LICENSE README.md"
          for file in $CP_FILES; do
            if [ -f "$file" ]; then cp "$file" dist_theme/; fi
          done
          
          mkdir -p dist_theme/assets
          cp -r assets/* dist_theme/assets/
          
          cd dist_theme
          zip -r "../${ZIP_NAME}" .
          cd ..

      - name: Create GitHub Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.versioning.outputs.NEW_TAG }}
          name: Release ${{ steps.versioning.outputs.NEW_TAG }}
          files: ${{ steps.package_theme.outputs.ZIP_NAME }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifact (For PRs)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: feather-theme-preview
          path: ${{ steps.package_theme.outputs.ZIP_NAME }}
          retention-days: 7

